本指引介绍如何将 MSDK V5 Sample 中的 MSDK 包和 UXSDK 开源框架移植到用户的空白项目中。

> **说明：**
>
> * 本指引中使用的 Android Studio 版本为 **Android Studio Chipmunk 2021.2.1 Patch 1**，使用的 MSDK 版本为 5.3.0，UXSDK 的适配版本为 MSDK 5.3.0
> * **Android Gradle Plugin 版本为 4.2.2**
> * Android 适用的版本范围仅为 23–29，Kotlin 推荐版本 1.6.10，Gradle 推荐版本 6.9
> * 在 File > Project Structure 中配置 Gradle 版本，在教程中涉及的配置文件中配置 Android 和 Kotlin 版本，如需使用非推荐版本，请根据实际版本自行适配整个集成过程

## 获取已集成 MSDK 的空白工程

如果不打算按照下述教程手动配置你的工程，可以选择下载 [[已集成 MSDK 5.3.0 的空白工程]](https://terra-1-g.djicdn.com/71a7d383e71a4fb8887a310eb746b47f/msdk/MyApplication.zip)，参考本文档从 <a href="#test">**测试与调试**</a> 处直接开始进行最后一步配置与调试。

## 新建空白项目

1. 在 Android Studio 启动页，选择 New Project > Phone and Tablet > Empty Activity
2. 按照下图完成配置。
   * Name：`My Application`
   * Package name：`com.example.myapplication`
   * Minimum SDK：`23`

<img src = "https://terra-1-g.djicdn.com/71a7d383e71a4fb8887a310eb746b47f/msdk/Documentation/v5.3/empty%20project%20config.jpeg" alt = "empty project">

## 修改 build.gradle (Project) 文件

打开 <code>Gradle Scripts</code> 下的 <code>build.gradle (Project)</code>，按照如下代码修改内容，这段代码的作用是提供正确的引用库。

```java
buildscript {
    ext.kotlin_version = '1.6.10' //DJI MSDK 建议的版本
    repositories {
        google()
        jcenter()
        mavenCentral()
    }
    dependencies {
        classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version"
        classpath "com.android.tools.build:gradle:4.2.2" //DJI MSDK 建议的版本
	    // ... (remaining code)
    }
}

allprojects {
    repositories {
        google()
        jcenter()
        mavenCentral()
    }
}

task clean(type: Delete) {
    delete rootProject.buildDir
}
```


## 修改 build.gradle (Module: app) 文件

1. 在 <code>android</code> 项中的<code>defaultConfig</code>中配置 <code>sdkversion</code> 以及 <code>ndk</code>，配置 <code>packagingOptions</code>。

注意版本：
* <code>compileSdkVersion</code> 和 <code>targetSdkVersion</code> 为 29。
* <code>minSdkVersion</code> 的最低版本号需要升级到 23。

```java
android {
    compileSdk 29 //DJI MSDK 支持的版本

    defaultConfig {
        applicationId "com.example.myapplication"
        minSdk 23 //DJI MSDK 支持的版本
        targetSdk 29 //DJI MSDK 支持的版本
        versionCode 1
        versionName "1.0"

        testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"

        ndk {
            abiFilters 'arm64-v8a'
        }
    }

        packagingOptions {
            pickFirst 'lib/arm64-v8a/libc++_shared.so'
            pickFirst 'lib/armeabi-v7a/libc++_shared.so'
        }

        packagingOptions {
            doNotStrip "*/*/libconstants.so"
            doNotStrip "*/*/libdji_innertools.so"
            doNotStrip "*/*/libdjibase.so"
            doNotStrip "*/*/libDJICSDKCommon.so"
            doNotStrip "*/*/libDJIFlySafeCore-CSDK.so"
            doNotStrip "*/*/libdjifs_jni-CSDK.so"
            doNotStrip "*/*/libDJIRegister.so"
            doNotStrip "*/*/libdjisdk_jni.so"
            doNotStrip "*/*/libDJIUpgradeCore.so"
            doNotStrip "*/*/libDJIUpgradeJNI.so"
            doNotStrip "*/*/libDJIWaypointV2Core-CSDK.so"
            doNotStrip "*/*/libdjiwpv2-CSDK.so"
            doNotStrip "*/*/libffmpeg.so"
            doNotStrip "*/*/libFlightRecordEngine.so"
            doNotStrip "*/*/libvideo-framing.so"
            doNotStrip "*/*/libwaes.so"
            doNotStrip "*/*/libagora-rtsa-sdk.so"
            doNotStrip "*/*/libc++.so"
            doNotStrip "*/*/libc++_shared.so"
            doNotStrip "*/*/libmrtc_28181.so"
            doNotStrip "*/*/libmrtc_agora.so"
            doNotStrip "*/*/libmrtc_core.so"
            doNotStrip "*/*/libmrtc_core_jni.so"
            doNotStrip "*/*/libmrtc_data.so"
            doNotStrip "*/*/libmrtc_log.so"
            doNotStrip "*/*/libmrtc_onvif.so"
            doNotStrip "*/*/libmrtc_rtmp.so"
            doNotStrip "*/*/libmrtc_rtsp.so"
        }

        //... (remaining code)
```


2. 在 <code>dependencies</code> 中配置 sdk 包，并将其他引用库修改到对应的版本。

```java
dependencies {
    implementation 'com.dji:dji-sdk-v5-aircraft:5.3.0'
    compileOnly 'com.dji:dji-sdk-v5-aircraft-provided:5.3.0'
    runtimeOnly 'com.dji:dji-sdk-v5-networkImp:5.3.0'
    
    //... (remaining code)
}
```

3. 修改混淆文件。

拷贝 [sample.pro 文件](https://github.com/dji-sdk/Mobile-SDK-Android-V5/blob/dev-sdk-main/SampleCode-V5/android-sdk-v5-as/proguard-relative/sample.pro) 的内容复制到你的项目中的 <code>proguard-rules.pro</code> 文件中。


## 修改 AndroidManifest.xml 文件
以下操作请参考 MSDK V5 Sample 的 [AndroidManifest.xml](https://github.com/dji-sdk/Mobile-SDK-Android-V5/blob/dev-sdk-main/SampleCode-V5/android-sdk-v5-sample/app-aircraft/src/main/AndroidManifest.xml) 文件进行修改，注意代码段与标签之间位置。

1. 参照添加 SDK 需要的最基础权限。在添加权限前，请确认已了解 [MSDK V5 都需要哪些安卓系统权限](https://djisdksupport.zendesk.com/knowledge/articles/11614807262489/zh-cn?brand_id=1017958) 和 [权限具体含义](https://developer.android.com/reference/android/Manifest.permission)。

```java
    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />
    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />
    <uses-permission android:name="android.permission.RECORD_AUDIO" />
```

2. 在 <code>manifest</code> 标签内添加 USB 相关权限，为了连接遥控器使用。

```java
<uses-feature
    android:name="android.hardware.usb.host"
    android:required="false"/>
<uses-feature
    android:name="android.hardware.usb.accessory"
    android:required="true"/>
```

3. 在 <code>application</code> 标签中添加 <code>Myapplication</code> 文件的声明，启动的时候需要加载。

```java
  <application
    android:name=".MyApplication"
    //... (remaining code)

```

4. 在 <code>application</code> 标签属性修改为如下代码段，用于配置 app key。

前往 [开发者网站](https://developer.dji.com/user) 申请 app key，申请 app key 时，Package Name 需填写 <code>com.example.myapplication</code>。
成功后将如下代码添加到 <code>application</code> 项中，保持<code>android:name</code>不变，将<code>android:value</code>中的 your app key 替换为你申请的 app key。

![](https://terra-1-g.djicdn.com/71a7d383e71a4fb8887a310eb746b47f/msdk/Documentation/V5.1/appkey.png)

```java
<meta-data
    android:name="com.dji.sdk.API_KEY"
    android:value="your app key"/>
```


5. 在 <code>activity</code> 标签中配置 USB 配件通知。

```java
<intent-filter>
    <action android:name="android.intent.action.MAIN" />
    <action android:name="android.hardware.usb.action.USB_ACCESSORY_ATTACHED" />
    <category android:name="android.intent.category.LAUNCHER" />
</intent-filter>

<meta-data
    android:name="android.hardware.usb.action.USB_ACCESSORY_ATTACHED"
    android:resource="@xml/accessory_filter" />
```

## 新建 MyApplication.kt 文件

1. 在 <code>com.example.myapplication</code> 文件夹下新建 <code>MyApplication.kt</code> 文件，与 <code>MainActivity.kt</code> 同级。
2. 文件内容写为如下代码，作用是引入 SDK 的解密加固包。

> **注意：** 注意包名的一致性：com.example.myapplication。

```kotlin
package com.example.myapplication

import android.app.Application
import android.content.Context

class MyApplication : Application() {
    override fun attachBaseContext(base: Context?) {
        super.attachBaseContext(base)
        com.secneo.sdk.Helper.install(this)
    }
}
```

## 修改 MainActivity.kt 文件

将`MainActivity.kt`的内容替换成如下代码。

```kotlin
package com.example.myapplication
import androidx.appcompat.app.AppCompatActivity
import android.os.Bundle
import android.util.Log
import dji.v5.common.error.IDJIError
import dji.v5.common.register.DJISDKInitEvent
import dji.v5.manager.SDKManager
import dji.v5.manager.interfaces.SDKManagerCallback

class MainActivity : AppCompatActivity() {
    private val TAG = this::class.simpleName

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)
        registerApp()
    }
    private fun registerApp()
    {
        SDKManager.getInstance().init(this,object:SDKManagerCallback{
            override fun onInitProcess(event: DJISDKInitEvent?, totalProcess: Int) {
                Log.i(TAG, "onInitProcess: ")
                if (event == DJISDKInitEvent.INITIALIZE_COMPLETE) {
                    SDKManager.getInstance().registerApp()
                }
            }
            override fun onRegisterSuccess() {
                Log.i(TAG, "onRegisterSuccess: ")
            }
            override fun onRegisterFailure(error: IDJIError?) {
                Log.i(TAG, "onRegisterFailure: ")
            }
            override fun onProductConnect(productId: Int)
            {
                Log.i(TAG, "onProductConnect: ")
            }
            override fun onProductDisconnect(productId: Int) {
                Log.i(TAG, "onProductDisconnect: ")
            }
            override fun onProductChanged(productId: Int)
            {
                Log.i(TAG, "onProductChanged: ")
            }
            override fun
                    onDatabaseDownloadProgress(current: Long, total: Long) {
                Log.i(TAG, "onDatabaseDownloadProgress: ${current/total}")
            }
        })
    }
}
```

## 导入 UXSDK 开源框架

1. 将 UXSDK 项目（[android-sdk-v5-uxsdk](https://github.com/dji-sdk/Mobile-SDK-Android-V5/tree/dev-sdk-main/SampleCode-V5)）整个复制到 <code>MyApplication</code> 项目路径的根目录下，与 <code>app</code> 文件夹同级。

2. 修改 <code>gradle.properties</code> 文件，添加以下代码来配置正确的版本。

```java
#buildconfig
ANDROID_MIN_SDK_VERSION=23 //DJI MSDK 支持的版本
ANDROID_TARGET_SDK_VERSION=29 //DJI MSDK 支持的版本
ANDROID_COMPILE_SDK_VERSION=29 //DJI MSDK 支持的版本
KOTLIN_VERSION='1.6.10' //DJI MSDK 建议的版本
```

3. 在与 <code>build.gradle (project)</code> 同级的路径下新建 <code>dependencies.gradle</code>，将 [dependencies.gradle](https://github.com/dji-sdk/Mobile-SDK-Android-V5/blob/dev-sdk-main/SampleCode-V5/android-sdk-v5-as/dependencies.gradle) 内容导入进去。
并将以下代码段加入 <code>build.gradle (Project)</code> 文件顶部。

```java
apply from:rootProject.file('dependencies.gradle')
```

4. 在 <code>setting.gradle</code> 文件中调整代码为以下内容。

```java
rootProject.name = "My Application"
include ':app'
include ':android-sdk-v5-uxsdk'
```
5. 文件夹目录 app > res > values > strings.xml，在文件中修改这行字符串的属性，这行代码的意义是修改 app 名称。

```java
<string name="your_app_name">My Application</string>
```

在实际开发中可以修改上面这行代码的 id 和字段，只需要和项目中 <code>AndroidManifest.xml</code> 中如下对应的 id 名称保持一致，在这个示例中应用程序的 id 名称为 "your_app_name"。

```java
<application
        android:label="@string/your_app_name">
```

至此你已经完成了空白项目的配置。

## <span id = "test">测试与调试</span>

1. 选择 "Sync Now" 同步工程。

2. 选择界面上的锤子图标，编译你的工程，并进行必要的调试。

> 由于空白项目的局限性，集成后 build 时偶现 <code>UXSDK</code> 包内容引用不到的报错，这不影响项目的正常运行，可以继续尝试第二部直接连接设备运行，如果在集成过程中发现解决此类报错的方法欢迎通过文档进行反馈。可能出现的报错如下：
```java
Execution failed for task ':android-sdk-v5-uxsdk:kaptGenerateStubsDebugKotlin'.
```
<string name="your_app_name">My Application</string>
```

5. 同步项目，至此你已经完成了空白项目的配置。

3. 连接 DJI 带屏遥控器或你的移动设备，打开相应的开发人员选择，在 Android Studio 右上角显示你的设备后选择 run'app' 三角图标，测试工程是否可以正常运行。
