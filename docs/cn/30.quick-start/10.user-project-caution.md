
本指引介绍如何将 MSDK V5 Sample 中的 MSDK 包和 UXSDK 开源框架移植到用户的空白项目中。

## 推荐环境

* Android Studio：`Android Studio Giraffe 2022.3.1`
* Java Runtime：`17` or `11`
* Kotlin：`1.7.21`
* Gradle：`7.6.2`
* Android Gradle Plugin：`7.4.2`
* minSdkVersion：`23`
* targetSdkVersion：`33`

> 如需使用非推荐版本，请根据实际版本自行适配整个集成过程。Android Studio Giraffe 2022.3.1 默认集成 Java Runtime 17，一般可以直接使用即可，无需做任何配置。

## 获取已集成 MSDK 的空白工程

如果不打算按照下述教程手动配置你的工程，可以选择下载 [[已集成 MSDK 的空白工程]](https://terra-1-g.djicdn.com/71a7d383e71a4fb8887a310eb746b47f/msdk/SDKSample.zip)，参考本文档从 <a href="#test">**测试与调试**</a> 处直接开始进行最后一步配置与调试。

## 新建空白项目

1. 在 Android Studio 启动页，选择 New Project > Phone and Tablet > Empty Views Activity
2. 按照下图完成配置。
   * Name：`MSDKSample`
   * Package name：`com.example.msdksample`
   * Minimum SDK：`24` 或者更高

<img src = "https://terra-1-g.djicdn.com/71a7d383e71a4fb8887a310eb746b47f/msdk/Documentation/5.8/MSDKproj.jpeg" alt = "empty project">

## 修改 build.gradle (Project) 文件

打开 <code>Gradle Scripts</code> 下的 <code>build.gradle (Project)</code>，按照如下代码修改内容，这段代码的作用是提供正确的引用库。

```java
buildscript {
    repositories {
        google()
        jcenter()
        mavenCentral()
    }
    dependencies {
		// 推荐的 Android Gradle Plugin 版本，不做强求，可以自定适配需要的版本。但是如果你需要引入 UXSDK 框架，则建议使用推荐版本，否则可能会出现编译兼容性问题。
        classpath "com.android.tools.build:gradle:7.4.2"

		// 推荐的 Kotlin 版本，如果你需要引入 UXSDK 框架，则建议使用推荐版本，否则可能会出现编译兼容性问题
        classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:1.7.21" //DJI MSDK 建议的版本
	    // ... (remaining code)
    }
}

allprojects {
    repositories {
        google()
        jcenter()
        mavenCentral()
    }
}

task clean(type: Delete) {
    delete rootProject.buildDir
}
```


## 修改 build.gradle (Module: app) 文件

1. 在 <code>android</code> 项中的<code>defaultConfig</code>中配置 <code>minSdkVersion</code> 以及 <code>ndk</code>，配置 <code>packagingOptions</code>。

注意版本：
* <code>minSdkVersion</code> 的最低版本号不要低于 23。

```java
android {
    compileSdkVersion 33 // 建议大于等 33，因为 MSDK 已经适配 Android 13 版本

    defaultConfig {
        applicationId "com.example.msdksample"
        minSdk 24
        targetSdk 33
        versionCode 1
        versionName "1.0"

        testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"

        ndk {
            abiFilters 'arm64-v8a' // 当前 MSDK 只支持 arm64-v8a 架构
        }

        // MSDK 相关的 so 库，加上一下配置
        packagingOptions {
            pickFirst 'lib/arm64-v8a/libc++_shared.so'
            pickFirst 'lib/armeabi-v7a/libc++_shared.so'
        }

        // MSDK 相关的 so 库，加上一下配置
        packagingOptions {
            doNotStrip "*/*/libconstants.so"
            doNotStrip "*/*/libdji_innertools.so"
            doNotStrip "*/*/libdjibase.so"
            doNotStrip "*/*/libDJICSDKCommon.so"
            doNotStrip "*/*/libDJIFlySafeCore-CSDK.so"
            doNotStrip "*/*/libdjifs_jni-CSDK.so"
            doNotStrip "*/*/libDJIRegister.so"
            doNotStrip "*/*/libdjisdk_jni.so"
            doNotStrip "*/*/libDJIUpgradeCore.so"
            doNotStrip "*/*/libDJIUpgradeJNI.so"
            doNotStrip "*/*/libDJIWaypointV2Core-CSDK.so"
            doNotStrip "*/*/libdjiwpv2-CSDK.so"
            doNotStrip "*/*/libFlightRecordEngine.so"
            doNotStrip "*/*/libvideo-framing.so"
            doNotStrip "*/*/libwaes.so"
            doNotStrip "*/*/libagora-rtsa-sdk.so"
            doNotStrip "*/*/libc++.so"
            doNotStrip "*/*/libc++_shared.so"
            doNotStrip "*/*/libmrtc_28181.so"
            doNotStrip "*/*/libmrtc_agora.so"
            doNotStrip "*/*/libmrtc_core.so"
            doNotStrip "*/*/libmrtc_core_jni.so"
            doNotStrip "*/*/libmrtc_data.so"
            doNotStrip "*/*/libmrtc_log.so"
            doNotStrip "*/*/libmrtc_onvif.so"
            doNotStrip "*/*/libmrtc_rtmp.so"
            doNotStrip "*/*/libmrtc_rtsp.so"
        }

        //... (remaining code)
```


2. 在 <code>dependencies</code> 中配置 sdk 包，并将其他引用库修改到对应的版本。

**注意：{sdkversion} 为 MSDK 最新版本，请自行替换，譬如替换为 5.8.0**

```java
dependencies {
    implementation 'com.dji:dji-sdk-v5-aircraft:{sdkversion}'
    compileOnly 'com.dji:dji-sdk-v5-aircraft-provided:{sdkversion}'
    //... (remaining code)
}
```


## 修改 AndroidManifest.xml 文件
以下操作请参考 MSDK V5 Sample 的 [AndroidManifest.xml](https://github.com/dji-sdk/Mobile-SDK-Android-V5/blob/dev-sdk-main/SampleCode-V5/android-sdk-v5-sample/app-aircraft/src/main/AndroidManifest.xml) 文件进行修改，注意代码段与标签之间位置。

1. 参照添加 SDK 需要的最基础权限。在添加权限前，请确认已了解 [MSDK V5 都需要哪些安卓系统权限](https://djisdksupport.zendesk.com/knowledge/articles/11614807262489/zh-cn?brand_id=1017958) 和 [权限具体含义](https://developer.android.com/reference/android/Manifest.permission)。

```java
    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />
    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />
    <uses-permission android:name="android.permission.RECORD_AUDIO" />
```

2. 在 <code>manifest</code> 标签内添加 USB 相关权限，为了连接遥控器使用。

```java
<uses-feature
    android:name="android.hardware.usb.host"
    android:required="false"/>
<uses-feature
    android:name="android.hardware.usb.accessory"
    android:required="true"/>
```

3. 在 <code>application</code> 标签中添加 <code>Myapplication</code> 文件的声明，启动的时候需要加载。

```java
  <application
    android:name=".MyApplication"
    //... (remaining code)

```

4. 在 <code>application</code> 标签属性修改为如下代码段，用于配置 app key。

前往 [开发者网站](https://developer.dji.com/user) 申请 app key，申请 app key 时，Package Name 需填写 <code>com.example.msdksample</code>。
成功后将如下代码添加到 <code>application</code> 项中，保持<code>android:name</code>不变，将<code>android:value</code>中的 your app key 替换为你申请的 app key。

<div>
<div align=center>
<img src="https://terra-1-g.djicdn.com/71a7d383e71a4fb8887a310eb746b47f/msdk/Documentation/5.8/msdksample.png" style="width:400px"/>
</div>
</div>

```java
<meta-data
    android:name="com.dji.sdk.API_KEY"
    android:value="your app key"/>
```


5. 在 <code>activity</code> 标签中配置 USB 配件通知。

```java
<intent-filter>
    <action android:name="android.intent.action.MAIN" />
    <action android:name="android.hardware.usb.action.USB_ACCESSORY_ATTACHED" />
    <category android:name="android.intent.category.LAUNCHER" />
</intent-filter>

<meta-data
    android:name="android.hardware.usb.action.USB_ACCESSORY_ATTACHED"
    android:resource="@xml/accessory_filter" />
```

## 新建 MyApplication.kt 文件

1. 在 <code>com.example.msdksample</code> 文件夹下新建 <code>MyApplication.kt</code> 文件，与 <code>MainActivity.kt</code> 同级。
2. 文件内容写为如下代码，作用是引入 SDK 的解密加固包。

> **注意：** 注意包名的一致性：com.example.msdksample。

```kotlin
package com.example.msdksample

import android.app.Application
import android.content.Context
import android.util.Log
import dji.v5.common.error.IDJIError
import dji.v5.common.register.DJISDKInitEvent
import dji.v5.manager.SDKManager
import dji.v5.manager.interfaces.SDKManagerCallback

class MyApplication : Application() {

	private val TAG = this::class.simpleName

    override fun attachBaseContext(base: Context?) {
        super.attachBaseContext(base)
        // 在调用 install 前，请勿调用任何 MSDK 相关
        com.secneo.sdk.Helper.install(this)
    }

    override fun onCreate() {
        super.onCreate()
        // 初始化 MSDK，建议初始化逻辑放在 Application 中，当然也可以根据自己的需要放在任意地方。
        SDKManager.getInstance().init(this,object:SDKManagerCallback{
            override fun onInitProcess(event: DJISDKInitEvent?, totalProcess: Int) {
                Log.i(TAG, "onInitProcess: ")
                if (event == DJISDKInitEvent.INITIALIZE_COMPLETE) {
                    SDKManager.getInstance().registerApp()
                }
            }
            override fun onRegisterSuccess() {
                Log.i(TAG, "onRegisterSuccess: ")
            }
            override fun onRegisterFailure(error: IDJIError?) {
                Log.i(TAG, "onRegisterFailure: ")
            }
            override fun onProductConnect(productId: Int) {
                Log.i(TAG, "onProductConnect: ")
            }
            override fun onProductDisconnect(productId: Int) {
                Log.i(TAG, "onProductDisconnect: ")
            }
            override fun onProductChanged(productId: Int)
            {
                Log.i(TAG, "onProductChanged: ")
            }
            override fun onDatabaseDownloadProgress(current: Long, total: Long) {
                Log.i(TAG, "onDatabaseDownloadProgress: ${current/total}")
            }
        })
    }
}
```

## 导入 UXSDK 开源框架

1. 将 UXSDK 项目（[android-sdk-v5-uxsdk](https://github.com/dji-sdk/Mobile-SDK-Android-V5/tree/dev-sdk-main/SampleCode-V5)）整个复制到 <code>SDKSample</code> 项目路径的根目录下，与 <code>app</code> 文件夹同级。

2. 修改 <code>gradle.properties</code> 文件，添加以下代码来配置正确的版本，因为 UXSDK Module 的<code>build.gradle</code>默认读取<code>gradle.properties</code>所定义的常量作为配置版本。当然你也可以直接修改<code>build.gradle</code>中的配置版本，但是建议使用 DJI 推荐的版本，否则可能有版本适配的成本。

```java
#buildconfig
ANDROID_MIN_SDK_VERSION=23 //DJI MSDK 最低支持的版本
ANDROID_TARGET_SDK_VERSION=33 //DJI MSDK 最高支持的版本
ANDROID_COMPILE_SDK_VERSION=33 //DJI MSDK 推荐使用的版本
```

3. 在与 <code>build.gradle (project)</code> 同级的路径下新建 <code>dependencies.gradle</code>，将 [dependencies.gradle](https://github.com/dji-sdk/Mobile-SDK-Android-V5/blob/dev-sdk-main/SampleCode-V5/android-sdk-v5-as/dependencies.gradle) 内容导入进去。
并将以下代码段加入 <code>build.gradle (Project)</code> 文件顶部。

```java
apply from:rootProject.file('dependencies.gradle')
```

4. 在 <code>setting.gradle</code> 文件中调整代码为以下内容。

```java
rootProject.name = "MSDKSample"
include ':app'
include ':android-sdk-v5-uxsdk'
```
5. 文件夹目录 app > res > values > strings.xml，在文件中修改这行字符串的属性，这行代码的意义是修改 app 名称。

```java
<string name="your_app_name">MSDKSample</string>
```

在实际开发中可以修改上面这行代码的 id 和字段，只需要和项目中 <code>AndroidManifest.xml</code> 中如下对应的 id 名称保持一致，在这个示例中应用程序的 id 名称为 "your_app_name"。

```java
<application
        android:label="@string/your_app_name">
```

至此你已经完成了空白项目的配置。

## <span id = "test">测试与调试</span>

1. 选择 "Sync Now" 同步工程。

2. 选择界面上的锤子图标，编译你的工程，并进行必要的调试。

> 由于空白项目的局限性，集成后 build 时偶现 <code>UXSDK</code> 包内容引用不到的报错，这不影响项目的正常运行，可以继续尝试第二步直接连接设备运行，如果在集成过程中发现解决此类报错的方法欢迎通过文档进行反馈。可能出现的报错如下：

```java
Execution failed for task ':android-sdk-v5-uxsdk:kaptGenerateStubsDebugKotlin'.
```

3. 连接 DJI 带屏遥控器或你的移动设备，打开相应的开发人员选择，在 Android Studio 右上角显示你的设备后选择 run'app' 三角图标，测试工程是否可以正常运行。

