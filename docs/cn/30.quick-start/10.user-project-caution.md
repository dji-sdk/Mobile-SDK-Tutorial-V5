本指引介绍如何将 MSDK V5 Sample 中的 MSDK 包和 UXSDK 开源框架移植到用户的空白项目中。

> **说明：**
>
> * 本指引中使用的 Android Studio 版本为 Android Studio Bumblebee 2021.1.1 大黄蜂，使用的 MSDK 版本为 5.2.0，请根据实际版本自行适配整个集成过程
> * Android 适用的版本范围为 21 - 29
> * Kotlin 版本请使用 1.5.31

## 新建空白项目

1. 在 Android Studio 启动页，选择 New Project > Phone and Tablet > Empty Activity
2. 完成配置。
   * Name：`My Application`
   * Package name：`com.dji.myapplication`
   * Minimum SDK：`23`
3. compileSdkVersion 和 targetSdkVersion 为 29。

## 新建 MyApplication.kt 文件

1. 新建 MyApplication.kt 文件。
2. 参照 MSDK V5 Sample 的 [DJIAllApplication](https://github.com/dji-sdk/Mobile-SDK-Android-V5/blob/dev-sdk-main/SampleCode-V5/android-sdk-v5-sample/app-all/src/main/java/dji/sampleV5/all/DJIAllApplication.kt) 编辑成如下内容。代码的作用是引入 SDK 的解密加固包。

```
package com.dji.myapplication

import android.app.Application
import android.content.Context

class MyApplication : Application() {
    override fun attachBaseContext(base: Context?) {
        super.attachBaseContext(base)
        com.secneo.sdk.Helper.install(this)
    }
}
```


## 修改 build.gradle(Module) 文件

1. 在 dependencies 项里添加 MSDK 飞行器包，如只需全量包或手持包请参考 Sample 添加。

```
implementation "com.dji:dji-sdk-v5-aircraft:5.2.0"
implementation "com.dji:dji-sdk-v5-networkImp:5.2.0"
compileOnly "com.dji:dji-sdk-v5-aircraft-provided:5.2.0"

implementation 'com.squareup.okio:okio:1.15.0'
implementation 'com.squareup.wire:wire-runtime:2.2.0'
implementation 'com.airbnb.android:lottie:3.3.1'
```

> **说明：**
> 
> * dji-sdk-v5-aircraft：飞机主包，提供 MSDK 对飞机控制的支持。
> * dji-sdk-v5-networkImp：网络库包，为 MSDK 提供联网能力。
> * dji-sdk-v5-aircraft-provided：飞机编译包，提供飞机包相关接口。

2. 在 android 项里添加 packagingOptions。

```
packagingOptions {
    doNotStrip "*/*/libconstants.so"
    doNotStrip "*/*/libdji_innertools.so"
    doNotStrip "*/*/libdjibase.so"
    doNotStrip "*/*/libDJICSDKCommon.so"
    doNotStrip "*/*/libDJIFlySafeCore-CSDK.so"
    doNotStrip "*/*/libdjifs_jni-CSDK.so"
    doNotStrip "*/*/libDJIRegister.so"
    doNotStrip "*/*/libdjisdk_jni.so"
    doNotStrip "*/*/libDJIUpgradeCore.so"
    doNotStrip "*/*/libDJIUpgradeJNI.so"
    doNotStrip "*/*/libDJIWaypointV2Core-CSDK.so"
    doNotStrip "*/*/libdjiwpv2-CSDK.so"
    doNotStrip "*/*/libffmpeg.so"
    doNotStrip "*/*/libFlightRecordEngine.so"
    doNotStrip "*/*/libvideo-framing.so"
    doNotStrip "*/*/libwaes.so"
    doNotStrip "*/*/libagora-rtsa-sdk.so"
    doNotStrip "*/*/libc++.so"
    doNotStrip "*/*/libc++_shared.so"
    doNotStrip "*/*/libmrtc_28181.so"
    doNotStrip "*/*/libmrtc_agora.so"
    doNotStrip "*/*/libmrtc_core.so"
    doNotStrip "*/*/libmrtc_core_jni.so"
    doNotStrip "*/*/libmrtc_data.so"
    doNotStrip "*/*/libmrtc_log.so"
    doNotStrip "*/*/libmrtc_onvif.so"
    doNotStrip "*/*/libmrtc_rtmp.so"
    doNotStrip "*/*/libmrtc_rtsp.so"
}
```

3. 拷贝 [sample.pro 文件](https://github.com/dji-sdk/Mobile-SDK-Android-V5/blob/dev-sdk-main/SampleCode-V5/android-sdk-v5-as/proguard-relative/sample.pro) 的内容复制到你的项目中的 proguard-rules 文件中。

## 修改 AndroidManifest.xml 文件

1. 参照 Sample 的 [AndroidManifest.xml](https://github.com/dji-sdk/Mobile-SDK-Android-V5/blob/dev-sdk-main/SampleCode-V5/android-sdk-v5-sample/app-all/src/main/AndroidManifest.xml) 添加 SDK 需要的最基础权限。详情请阅读 [MSDK V5 都需要哪些安卓系统权限](https://djisdksupport.zendesk.com/knowledge/articles/11614807262489/zh-cn?brand_id=1017958)？ 点击查看 [权限具体含义](https://developer.android.com/reference/android/Manifest.permission)。


```
<uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
<uses-permission android:name="android.permission.ACCESS_WIFI_STATE" />
<uses-permission android:name="android.permission.INTERNET" />
<uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />
<uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
<uses-permission android:name="android.permission.KILL_BACKGROUND_PROCESSES"/>
<uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />
<uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />
<uses-permission android:name="android.permission.READ_PHONE_STATE" />
```

2. 参照 MSDK V5 Sample 的 [AndroidManifest.xml](https://github.com/dji-sdk/Mobile-SDK-Android-V5/blob/dev-sdk-main/SampleCode-V5/android-sdk-v5-sample/app-all/src/main/AndroidManifest.xml) 添加 USB 相关权限，为了连接遥控器使用。

```
<uses-feature
    android:name="android.hardware.usb.host"
    android:required="false"/>
<uses-feature
    android:name="android.hardware.usb.accessory"
    android:required="true"/>
```

3. 在 application 标签下添加 Myapplication 文件的声明，启动的时候需要加载。

```
<application
    android:name="com.dji.myapplication.MyApplication"
```

4. 参照 MSDK V5 Sample 的 [AndroidManifest.xml](https://github.com/dji-sdk/Mobile-SDK-Android-V5/blob/dev-sdk-main/SampleCode-V5/android-sdk-v5-sample/app-all/src/main/AndroidManifest.xml) 添加 SDK API KEY。用户需要使用工程中的 AndroidManifest.xml 中的`package`，前往 [开发者网站](https://developer.dji.com/user) 申请 appkey，成功后将`appkey`替换如下代码段中的`X`。<br/> 本指导中 `package=com.dji.myapplication`。申请 appkey 时，Package Name 需填写`com.dji.myapplication`。

```
<meta-data
    android:name="com.dji.sdk.API_KEY"
    android:value="X"/>
```

![](https://terra-1-g.djicdn.com/71a7d383e71a4fb8887a310eb746b47f/msdk/Documentation/V5.1/appkey.png)

5. 在 activity 标签下添加 intent-filter 和 meta-data。

```
<intent-filter>
    <action android:name="android.intent.action.MAIN" />
    <action android:name="android.hardware.usb.action.USB_ACCESSORY_ATTACHED" />
    <category android:name="android.intent.category.LAUNCHER" />
</intent-filter>

<meta-data
    android:name="android.hardware.usb.action.USB_ACCESSORY_ATTACHED"
    android:resource="@xml/accessory_filter" />
```

## 修改 MainActivity.kt 文件

添加 MSDK 的 init 函数即可。

```
package com.dji.myapplication

import android.os.Bundle
import android.util.Log
import androidx.appcompat.app.AppCompatActivity
import dji.v5.common.error.IDJIError
import dji.v5.common.register.DJISDKInitEvent
import dji.v5.manager.SDKManager
import dji.v5.manager.interfaces.SDKManagerCallback

class MainActivity : AppCompatActivity() {
    private val TAG = "myApp"

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)
        registerApp()
    }

    private fun registerApp() {
        SDKManager.getInstance().init(this, object : SDKManagerCallback {
            override fun onRegisterSuccess() {
                Log.i(TAG, "myApp onRegisterSuccess")
            }

            override fun onRegisterFailure(error: IDJIError) {
                Log.i(TAG, "myApp onRegisterFailure")
            }

            override fun onProductDisconnect(productId: Int) {
                Log.i(TAG, "myApp onProductDisconnect")
            }

            override fun onProductConnect(productId: Int) {
                Log.i(TAG, "myApp onProductConnect")
            }

            override fun onProductChanged(productId: Int) {
                Log.i(TAG, "myApp onProductChanged")
            }

            override fun onInitProcess(event: DJISDKInitEvent, totalProcess: Int) {
                Log.i(TAG, "myApp onInitProcess")
                if (event == DJISDKInitEvent.INITIALIZE_COMPLETE) {
                    Log.i(TAG, "myApp start registerApp")
                    SDKManager.getInstance().registerApp()
                }
            }

            override fun onDatabaseDownloadProgress(current: Long, total: Long) {
                Log.i(TAG, "myApp onDatabaseDownloadProgress")
            }
        })
    }
}
```

## 导入 UXSDK 开源框架

1. 将 UXSDK 项目（[android-sdk-v5-uxsdk](https://github.com/dji-sdk/Mobile-SDK-Android-V5/tree/dev-sdk-main/SampleCode-V5)）整个复制到myapplication项目路径的app/libs文件夹下。
2. 工具栏点击 File > New > Import Module，选择myapplication项目路径的app/libs文件夹下的android-sdk-v5-uxsdk。
3. 修改settings.gradle文件。

```
rootProject.name = "My Application"
include ':app', ':android-sdk-v5-uxsdk'
project(':android-sdk-v5-uxsdk').projectDir = new File(rootDir, 'app/libs/android-sdk-v5-uxsdk/')
```

4. 修改build.gradle(:android-sdk-v5-uxsdk)文件中的配置和myApplication项目一致。

```
apply plugin: 'com.android.library'
apply plugin: 'kotlin-android'
apply plugin: 'kotlin-android-extensions'
apply plugin: 'kotlin-kapt'

android {
    compileSdkVersion 32

    resourcePrefix "uxsdk_"
    defaultConfig {
        minSdkVersion 23
        targetSdkVersion 32
        versionCode 1
        versionName "1.0"
    }

    compileOptions {
        sourceCompatibility JavaVersion.VERSION_1_8
        targetCompatibility JavaVersion.VERSION_1_8
    }

    kotlinOptions{
        jvmTarget = JavaVersion.VERSION_1_8
    }
}

dependencies {
    implementation 'androidx.annotation:annotation:1.1.0'
    implementation 'androidx.appcompat:appcompat:1.3.1'
    implementation 'androidx.multidex:multidex:2.0.1'
    implementation 'androidx.legacy:legacy-support-v4:1.0.0'
    implementation 'androidx.recyclerview:recyclerview:1.1.0'
    implementation 'com.squareup.okio:okio:1.15.0'
    implementation 'com.squareup.wire:wire-runtime:2.2.0'
    implementation 'androidx.constraintlayout:constraintlayout:1.1.3'
    implementation 'androidx.lifecycle:lifecycle-common-java8:2.3.1'
    implementation 'androidx.lifecycle:lifecycle-runtime:2.3.1'
    implementation 'androidx.lifecycle:lifecycle-process:2.3.1'
    implementation 'androidx.media:media:1.0.0'
    implementation "org.jetbrains.kotlin:kotlin-stdlib-jdk7:$kotlin_version"
    implementation "androidx.core:core-ktx:1.3.2"
    api 'io.reactivex.rxjava3:rxandroid:3.0.0'
    implementation 'com.airbnb.android:lottie:3.3.1'
    implementation 'androidx.cardview:cardview:1.0.0'

    api 'org.maplibre.gl:android-plugin-annotation-v9:1.0.0'
    api 'org.maplibre.gl:android-sdk-turf:5.9.0'
    api 'org.maplibre.gl:android-sdk:9.4.2'
    api 'com.amap.api:3dmap:7.3.0'
    api 'com.amap.api:search:7.3.0'

    api 'com.google.android.gms:play-services-places:16.0.0'
    api 'com.google.android.gms:play-services-maps:16.0.0'
    api 'com.google.android.gms:play-services-location:16.0.0'
    api 'com.google.android.gms:play-services-base:16.0.0'

    compileOnly "com.dji:dji-sdk-v5-aircraft-provided:5.2.0"
    compileOnly "com.dji:dji-sdk-v5-aircraft:5.2.0"
}
```

5. 同步工程。
